name: Dependabot 自动合并
on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    # 仅处理来自dependabot且包含特定标签的PR
    if: |
      github.actor == 'dependabot[bot]' &&
      contains(github.event.pull_request.labels.*.name, 'dependencies')
    runs-on: ubuntu-latest
    steps:
      - name: 等待 CI 检查通过
        uses: actions/github-script@v7
        with:
          script: |
            // 等待所有必需的检查通过
            const { data: checks } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.payload.pull_request.head.sha
            });
            const allPassed = checks.check_runs.every(run => run.conclusion === 'success');
            if (!allPassed) {
              core.setFailed('有些检查未通过');
            }
      - name: 自动合并 PR
        if: success()
        run: |
          gh pr merge --auto --merge "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}